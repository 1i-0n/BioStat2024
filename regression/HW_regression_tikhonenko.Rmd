---
title: "Анализ связи физической активности с HbA1c"
author: "Anton Tikhonenko"
date: "2024-12-20"
output: html_document
---

---
title: "Анализ связи физической активности с HbA1c"
output:
  html_document:
    keep_md: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(fig.width = 14, fig.height = 12)

library(tidyverse)
library(broom)
library(ggplot2)
library(corrplot)
library(pheatmap)
library(car)
library(corrr)
library(broom)
library(GGally)
theme_custom <- theme_bw()+ theme(
    plot.title = element_text(size = 30, hjust = 0.5),
    plot.subtitle = element_text(size = 25, hjust = 0.5),
    strip.text = element_text(size = 20),
    axis.text = element_text(size = 20),
    axis.title = element_text(size = 25),
    legend.title = element_text(size = 25),
    legend.text = element_text(size = 20)
  )
theme_set(theme_custom)
```

# Введение

В данном отчёте проводится регрессионный анализ связи физической активности с уровнем гликированного гемоглобина (HbA1c).

# Загрузка данных

```{r data-load}
data <- readxl::read_excel("./HW_data.xlsx")
head(data)
data %>% select("PAD630", "PAD645", "PAD675","PAQ625", "PAQ640", "PAQ670","PAD615", "PAD660","PAQ610", "PAQ655" ) %>% summary()

```

# Подготовка данных
## Определение переменных для физической активности
```{r data-prep}
moderate_minutes_vars <- c("PAD630", "PAD645", "PAD675") # Умеренная активность (в минутах)
moderate_days_vars <- c("PAQ625", "PAQ640", "PAQ670")   # Умеренная активность (количество дней)

vigorous_minutes_vars <- c("PAD615", "PAD660")          # Интенсивная активность (в минутах)
vigorous_days_vars <- c("PAQ610", "PAQ655")             # Интенсивная активность (количество дней)

# Вычисления и категоризация
data <- data %>%
  mutate(
    Moderate_Minutes = rowSums(across(all_of(moderate_minutes_vars)) *
                                 across(all_of(moderate_days_vars)), na.rm = TRUE),
    Vigorous_Minutes = rowSums(across(all_of(vigorous_minutes_vars)) *
                                 across(all_of(vigorous_days_vars)), na.rm = TRUE),
    Activity_Index = round((Moderate_Minutes + 2 * Vigorous_Minutes) / 150, 2),
    Activity_Presence = Activity_Index !=0,  
    Activity_Category = case_when(
      Moderate_Minutes >= 150 | Vigorous_Minutes >= 75 ~ "Active",
      TRUE ~ "Inactive"
    
    )
  )

# Сводка данных
summary <- data %>%
  select(Moderate_Minutes, Vigorous_Minutes, Activity_Index, Activity_Category, Activity_Presence) %>%
  summary()

# Вывод сводки
print(summary)
```
### Введенные переменные

1. **Moderate_Minutes**  
Отражает общее количество минут умеренной физической активности в неделю, рассчитанное путем умножения минут активности на количество дней и их суммирования. Эта переменная необходима для учета важного компонента общей физической активности.

2. **Vigorous_Minutes**  
Представляет общее количество минут интенсивной физической активности в неделю, рассчитанное аналогично умеренной активности. Интенсивная активность имеет большее влияние на здоровье, что делает её важной для анализа.

3. **Activity_Index**  
Индекс активности объединяет умеренную и интенсивную активность, учитывая их различное влияние (интенсивная умножается на 2), и нормализует результат по шкале, основанной на рекомендациях ВОЗ (150 минут). Это дает интегральную оценку уровня активности. Таким образом его значения от 1 и более характеризует человека как физически активного. 

4. **Activity_Category**  
Классифицирует участников как "Physically Active" или "Physically Inactive" на основе выполнения рекомендаций ВОЗ (≥150 минут умеренной или ≥75 минут интенсивной активности в неделю). Категория помогает быстро интерпретировать соответствие участников стандартам активности.

5. **Activity_Presence**
Наличие физической активности по опроснику. 

```{r data-modify}

# Выбор необходимых переменных и преобразование
cleaned_data <- data %>%
  select(
    SEQN, RIAGENDR, RIDAGEYR, RIDRETH3, DMDEDUC2, DMDMARTL,
    INDFMIN2, LBXGH, BPXSY, BPXDI, BMXBMI, #BMXWT, BMXHT,
    SMQ020, SMQ040, MCQ010, MCQ035, MCQ160C, MCQ160B,
    MCQ160E, MCQ160F, MCQ160M, MCQ170M, MCQ160O,
    MCQ220, BPQ020, BPQ050A, DIQ010, DIQ070, 
    Moderate_Minutes, Vigorous_Minutes, Activity_Index, Activity_Category, Activity_Presence
  ) %>%
  rename(
    ID = SEQN,
    Sex = RIAGENDR,
    Age = RIDAGEYR,
    Race = RIDRETH3,
    Education = DMDEDUC2,
    Marital_Status = DMDMARTL,
    Family_Income = INDFMIN2,
    Glycohemoglobin = LBXGH,
    Systolic_BP = BPXSY,
    Diastolic_BP = BPXDI,
    BMI = BMXBMI,
    Smoked_100_Cigarettes = SMQ020,
    Currently_Smokes = SMQ040,
    Asthma_Ever = MCQ010,
    Asthma_Now = MCQ035,
    Coronary_Heart_Disease = MCQ160C,
    Congestive_Heart_Failure = MCQ160B,
    Heart_Attack = MCQ160E,
    Stroke = MCQ160F,
    Thyroid_Problem_Ever = MCQ160M,
    Thyroid_Problem_Now = MCQ170M,
    COPD = MCQ160O,
    Cancer_Ever = MCQ220,
    High_BP_Ever = BPQ020,
    High_BP_Meds_Now = BPQ050A,
    Diabetes_Ever = DIQ010,
    Diabetes_Meds_Now = DIQ070
  ) %>%
  mutate(
    # Преобразование Sex до общей обработки
    Sex = factor(Sex, levels = c(1, 2), labels = c("Male", "Female")),
    
    # Замена значения 9 на 2 устраняем опечатки в исходных данных
    High_BP_Ever = ifelse(High_BP_Ever == 9, 2, High_BP_Ever),
    Thyroid_Problem_Ever = ifelse(Thyroid_Problem_Ever == 9, 2, Thyroid_Problem_Ever),
    
    # Преобразование дихотомических переменных в факторы с уровнями Yes/No
    across(
      where(~ all(. %in% c(1, 2))), 
      ~ factor(.x, levels = c(1, 2), labels = c("Yes", "No"))
    ),
    
    # Преобразование переменной Currently_Smokes
    Currently_Smokes = factor(Currently_Smokes, levels = c(1, 2, 3),
                              labels = c("Every day", "Some days", "Not at all")),
    
    # Преобразование категориальных переменных
    Race = factor(Race, levels = c(1, 2, 3, 4, 6, 7),
                  labels = c("Mexican American", "Other Hispanic",
                             "Non-Hispanic White", "Non-Hispanic Black",
                             "Non-Hispanic Asian", "Other/Multi-Racial")),
    Education = factor(Education, levels = c(1, 2, 3, 4, 5),
                       labels = c("Less than 9th grade", "9-11th grade",
                                  "High school graduate/GED",
                                  "Some college/AA degree",
                                  "College graduate or above")),
    Marital_Status = factor(Marital_Status, levels = c(1, 2, 3, 4, 5, 6),
                            labels = c("Married", "Widowed", "Divorced",
                                       "Separated", "Never married", "Living with partner")),
    Family_Income = factor(Family_Income, levels = 1:12,
                           labels = c("$0-$4,999", "$5,000-$9,999", "$10,000-$14,999",
                                      "$15,000-$19,999", "$20,000-$24,999", "$25,000-$34,999",
                                      "$35,000-$44,999", "$45,000-$54,999", "$55,000-$64,999",
                                      "$65,000-$74,999", "$75,000-$99,999", "$100,000+")),
     # Считаем количество сопутствующих заболеваний
    Comorbidities_Score = rowSums(across(c(
      Asthma_Now, 
      Coronary_Heart_Disease,
      Congestive_Heart_Failure,
      Heart_Attack,
      Stroke,
      Thyroid_Problem_Ever,
      Thyroid_Problem_Now,
      COPD,
      Cancer_Ever,
      High_BP_Ever,
      High_BP_Meds_Now,
      Diabetes_Ever,
      Diabetes_Meds_Now
    ), ~ . == "Yes")),
    Systolic_BP = round(Systolic_BP),
    Diastolic_BP = round(Diastolic_BP)
  )

# Проверка структуры данных
glimpse(cleaned_data)



# Проверим структуру данных

```
### **Оценка физической активности респондентов**

Физическая активность респондентов будет оцениваться на основе двух ключевых показателей: **умеренной физической активности** (Moderate_Minutes) и **интенсивной физической активности** (Vigorous_Minutes). Эти переменные отражают количество минут, затраченных респондентами на соответствующую активность в неделю. Для получения интегрального показателя активности используется индекс активности (Activity_Index), который рассчитывается по формуле:

\[
\text{Activity\_Index} = \frac{\text{Moderate Minutes} + 2 \times \text{Vigorous Minutes}}{150}
\]

Значения от 1 и более будут харектиризовать респондента как физически активного. Это соответствует классификации ВОЗ.

Мы предполагаем, что физическая активность может быть обратно ассоциирована с уровнями гликированного гемоглобина (HbA1c), так как она способствует улучшению чувствительности к инсулину и снижению уровней глюкозы в крови.

---

### 2. **Ковариаты для модели и их оценка**

Для коррекции эффекта физической активности на гликированный гемоглобин будут включены следующие ковариаты:

- **Comorbidities (Сопутствующие заболевания)**: 
Будем учитывать интегральную переменную **Comorbidities_Score (Суммарное количество сопутствующих заболеваний)**  
Эта числовая переменная отражает общее количество хронических заболеваний у респондента, включая следующие состояния: 
  - Наличие астмы в настоящий момент (`Asthma_Now`),
  - Ишемическая болезнь сердца (`Coronary_Heart_Disease`),
  - Хроническая сердечная недостаточность (`Congestive_Heart_Failure`),
  - Инфаркт миокарда (`Heart_Attack`),
  - Инсульт (`Stroke`),
  - Проблемы с щитовидной железой (в прошлом и в настоящее время: `Thyroid_Problem_Ever`, `Thyroid_Problem_Now`),
  - ХОБЛ (хроническая обструктивная болезнь легких) (`COPD`),
  - Рак (в любом периоде) (`Cancer_Ever`),
  - Повышенное артериальное давление (в прошлом и в настоящее время: `High_BP_Ever`, `High_BP_Meds_Now`),
  - Диабет (в прошлом и в настоящее время: `Diabetes_Ever`, `Diabetes_Meds_Now`).
- **Race (Расовая/этническая принадлежность)**: Категориальная переменная, отражающая различия в предрасположенности к диабету и физических особенностях.
- **Sex (Пол)**: Категориальная переменная (Male/Female), учитывающая физиологические различия между мужчинами и женщинами.
- **Smoking Курение (Currently_Smokes)**: Категориальная переменная, так как курение ассоциировано с повышенным уровнем HbA1c.

Эти переменные будут оцениваться по данным из анкеты и клинических измерений. Все ковариаты введены как корректирующие факторы, чтобы минимизировать возможные искажения в оценке ассоциации между физической активностью и уровнем HbA1c.

---



### 3. **Роль каждого показателя в DAG**

#### **Конфаундеры**
Эти переменные искажают связь между физической активностью и HbA1c, если их не учитывать при анализе:

- **Экспозиция (Exposure):** Физическая активность (Physical activity).
- **Исход (Outcome):** Гликированный гемоглобин (HbA1c).

**Основные конфаундеры:**
  - Возраст (Age).
  - Сопутствующие заболевания (Comorbidities).
  - Уровень образования (Education).
  - Доход семьи (Family income).
  - Расовая/этническая принадлежность (Race).
  - Пол (Sex).

**Proxy-конфаундеры:**
  - Курение (Smoking).


#### **Коллайдеры:**
Переменные, в которых сходятся независимые причинные пути, и корректировка на них может привести к смещению:
  - Артериальное давление (Blood pressure) между HbA1c и сопутствующими включая сопутствующие заболевания.
  - Лечение от диабета (Diabetic medication)

#### **Медиаторы:**
Переменные, через которые физическая активность оказывает влияние на HbA1c:
  - Индекс массы тела (BMI) между физической активностью и HbA1c. Физическая активность влияет на снижение массы тела, что, в свою очередь, связано с уровнем HbA1c.






# Эксплораторный анализ (EDA)

## Саммари

```{r}
summary(cleaned_data)
```

## Корреляционная матрица числовых переменных

```{r correlation_matrix, fig.height=8, fig.width=8}
# Выбираем только числовые переменные
cleaned_data_n <- cleaned_data %>%
  select(where(is.numeric)) %>%
  select(-ID)

# Построение корреляционной матрицы

data_cor <- cor(cleaned_data_n) 
corrplot(data_cor, method = "color", type = "lower", 
         addCoef.col = "grey30", diag = FALSE,
         cl.pos = "b", tl.col = "grey10",
         col = COL2('RdBu', 10))
```
Comorbidities Score имеет умеренную положительную корреляцию с возрастом (Age) и гликированным гемоглобином (Glycohemoglobin), что указывает на влияние возраста и наличия сопутствующих заболеваний на метаболические показатели. Систолическое давление (Systolic_BP) также показывает положительную корреляцию с возрастом, что согласуется с ожидаемыми физиологическими изменениями. 
---

## Сетевой график корреляций

```{r network_plot, fig.height=8, fig.width=8}


data_cor %>% 
  network_plot(min_cor = 0.0)
```
Сеть корреляций демонстрирует ожидаемые связи между показателями. Activity Index положительно коррелирует с Vigorous Minutes и Moderate Minutes, что отражает вклад различных видов активности в общий индекс. Comorbidities Score имеет отрицательную корреляцию с Glycohemoglobin, что указывает на возможное влияние сопутствующих заболеваний на метаболические показатели. Показатели артериального давления (Systolic BP и Diastolic BP) и BMI имеют положительные корреляции друг с другом, что подтверждает их тесную взаимосвязь. Эти результаты подчеркивают необходимость учета данных факторов при анализе влияния физической активности на уровень HbA1c.
---

## Парные графики числовых переменных

```{r pairwise_plot, fig.height=14, fig.width=14}

ggpairs(cleaned_data_n, progress = FALSE) +
  theme(
    axis.text = element_text(size = 10), 
    strip.text = element_text(size = 12) 
  )
```


## Связь индекса физической активности и уровня HbA1c

```{r activity_vs_hba1c,   fig.height=10, fig.width=12}
ggplot(data = cleaned_data, aes(x = Activity_Index, y = Glycohemoglobin)) +
  geom_point(alpha = 0.7, color = "blue") +
  geom_vline(xintercept = 1, linetype = "dashed", color = "red", size = 0.8) + # Граница активности
  geom_hline(yintercept = 6.5, linetype = "dashed", color = "green", size = 0.8) + # Референс уровня HbA1c
  labs(
    title = "Связь индекса физической активности и уровня HbA1c",
    x = "Индекс физической активности (Activity Index)",
    y = "Гликированный гемоглобин (HbA1c)"
  ) +
  theme_custom +
  theme(
    plot.title = element_text(hjust = 0.5),
    panel.grid.major = element_line(color = "gray", linetype = "dashed"),
    panel.grid.minor = element_blank()
  )
```
График показывает, что большинство респондентов имеют низкий уровень физической активности (Activity Index ≤ 5), при этом у них чаще наблюдаются повышенные уровни гликированного гемоглобина (HbA1c > 6.5), что может свидетельствовать о риске метаболических нарушений. У респондентов с более высокой физической активностью наблюдается тенденция к снижению уровня HbA1c, которая снижается при слишком высоких значениях (Activity Index > 40) И совсем исчезает после 50.
 
# Построение моделей

## Тестирование nested переменной

```{r}

library(tidyverse)
library(modelsummary)

# Проверка структуры данных
glimpse(cleaned_data)

# Построение nested модели
fit_nested <- lm(
  Glycohemoglobin ~ Activity_Presence * Activity_Index + 
    Sex + Race + Comorbidities_Score + Currently_Smokes,
  data = cleaned_data
)

# Модель только с наличием физической активности
fit_binary <- lm(
  Glycohemoglobin ~ Activity_Presence + 
    Sex + Race + Comorbidities_Score + Currently_Smokes,
  data = cleaned_data
)

# Модель только с уровнем физической активности
fit_duration <- lm(
  Glycohemoglobin ~ Activity_Index + 
    Sex + Race + Comorbidities_Score + Currently_Smokes,
  data = cleaned_data
)

# Сравнение моделей
modelsummary(
  list(
    "Nested модель (наличие * индекс ФА)" = fit_nested,
    "Только наличие ФА" = fit_binary,
    "Только индекс ФА" = fit_duration
  ),
  stars = TRUE
)


```


## Модель без ковариат

```{r crude-model}

# Исправленная модель без коллинеарности
model_1 <- lm(
  Glycohemoglobin ~ Activity_Presence + I(Activity_Presence * Activity_Index),
  data = cleaned_data
)

summary(model_fixed)



```

## Модель с ковариатами

```{r adjusted-model}
# Модель 2: С учетом ковариат

model_2 <- lm(
  Glycohemoglobin ~ Activity_Presence + I(Activity_Presence * Activity_Index) +
    Sex + Race + Comorbidities_Score + Currently_Smokes,
  data = cleaned_data
)

summary(model_fixed)

```
## Сравнение моделей


```{r}
anova(model_1, model_2)
```

## Диагностика моделей

```{r model-diagnostics}
par(mfrow = c(2, 2))

# Остатки модели без ковариат
plot(model_1)

# Остатки модели с ковариатами
plot(model_2)
crPlots(model_2)

# Проверка гетероскедастичности
library(car)
ncvTest(model_2)

```

### Диагностика и необходимость коррекции

#### Модель без ковариат:
- Остатки имеют значительные отклонения от нормальности, что видно на Q-Q графике.
- "Residuals vs Fitted" показывает некоторое систематическое поведение остатков, что указывает на нарушение линейности или неправильную спецификацию модели.
- Значения R² и p-value указывают, что физическая активность в данной модели не является значимым предиктором HbA1c.
- Модель недообъясняет вариабельность уровня HbA1c и требует доработки.

#### Модель с ковариатами:
- Модель с ковариатами значительно лучше объясняет вариабельность HbA1c (R² = 0.202).
- Остатки все еще не идеально нормальны (видно по Q-Q графику), но их распределение становится более равномерным.
- Включение Comorbidities_Score как важного предиктора (p < 0.001) улучшило модель. Однако связь физической активности с HbA1c остается незначимой (p = 0.1704).
- График "Residuals vs Leverage" указывает на несколько потенциальных выбросов с высокой рычаговой силой, которые могут повлиять на параметры модели.

#### Сравнение моделей:
- ANOVA показывает значительное улучшение модели с включением ковариат (p < 0.001).
- Модель с ковариатами подтверждает, что, хотя физическая активность сама по себе не является значимым предиктором, другие факторы, такие как Comorbidities_Score и раса, оказывают значительное влияние на HbA1c.

#### Коррекции:
1. **Исправление нормальности остатков**: Рассмотреть логарифмическое или иное преобразование переменной активности.
2. **Проверка выбросов**: Провести диагностику и, при необходимости, исключить или корректировать выбросы.


```{r}
library(sandwich)
library(lmtest)

# Пересчитываем стандартные ошибки с учетом гетероскедастичности
coeftest(model_2, vcov = vcovHC(model_2, type = "HC3"))

```

```{r}


```

### Выводы после обновления модели:

1. **Модель без ковариат**:
   - Логарифмирование индекса активности дало значимый отрицательный коэффициент (`-0.05125, p < 0.001`), что указывает на слабую отрицательную связь между физической активностью и уровнем HbA1c.
   - Однако модель объясняет только 2.1% дисперсии уровня HbA1c (Adjusted R² = 0.01994), что указывает на наличие других значимых факторов.

2. **Модель с ковариатами**:
   - Добавление ковариат, таких как пол, расовая принадлежность, коморбидности и статус курения, значительно улучшило модель:
     - Adjusted R² увеличился до 19.3%, что указывает на более высокую объяснительную способность модели.
     - Коэффициент для `Log_Activity_Index` остался отрицательным и значимым (`-0.023046, p = 0.037`), подтверждая связь между физической активностью и HbA1c даже с учетом других факторов.


```{r results}
# Извлечение коэффициентов и доверительных интервалов

model_1_results <- tidy(model_modified_1, conf.int = TRUE)
model_2_results <- tidy(model_modified_2, conf.int = TRUE)



# Объединение данных для визуализации
model_1_results <- model_1_results %>% mutate(Model = "Без ковариат")
model_2_results <- model_2_results %>% mutate(Model = "С ковариатами")
results_combined <- bind_rows(model_1_results, model_2_results) %>%
  filter(term == "Log_Activity_Index")

# Построение графика
ggplot(results_combined, aes(x = Model, y = estimate, ymin = conf.low, ymax = conf.high)) +
  geom_pointrange(color = "blue", size = 0.8) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  labs(
    title = "Точечная и интервальная оценка эффекта физической активности",
    x = "Модель",
    y = "Коэффициент (Log_Activity_Index)"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 16),
    axis.title = element_text(size = 14),
    axis.text = element_text(size = 12)
  )

```
### Интерпретация результатов

#### Точечная оценка
Точечная оценка эффекта физической активности, выраженного через логарифм индекса физической активности, показывает отрицательное значение в обеих моделях (с ковариатами и без них). Это указывает на тенденцию к снижению уровня гликированного гемоглобина при увеличении физической активности. Однако величина эффекта мала, что предполагает незначительное влияние физической активности на уровень HbA1c.

#### Интервальная оценка
Интервальная оценка (95%-й доверительный интервал) в модели без ковариат и с ковариатами включает значения, близкие к нулю, что означает, что эффект может быть как отрицательным, так и практически отсутствующим. Тем не менее доверительный интервал не пересекает 0, а значит минимальный эффект всегда есть. Добавление ковариат в модель приводит к небольшой стабилизации эффекта, но уменьшает выраженность.

#### Клиническая значимость
С точки зрения клинической значимости, наблюдаемый эффект логарифма физической активности на HbA1c мал и может быть недостаточным для оказания значимого клинического влияния. Чтобы подтвердить или опровергнуть клиническую значимость, можно было бы:
- Провести анализ на уровне подгрупп (например, различия между возрастными группами, по полу или наличию сопутствующих заболеваний).
- Сравнить эффект физической активности с установленными клиническими интервенциями, которые приводят к значимым изменениям HbA1c. А так же установить эффект комбинации этих воздействий.
- Увеличить объем данных или использовать дополнительные показатели физической активности, чтобы лучше оценить их влияние на HbA1c.


### Проверка гипотезы об отсутствии ассоциации между физической активностью и гликированным гемоглобином

Для проверки гипотезы об отсутствии ассоциации (нулевая гипотеза \( H_0 \): коэффициент при логарифме индекса активности равен нулю, \( \beta = 0 \)) были использованы обе модели:

1. **Модель без ковариат:**
   - Коэффициент: \(-0.05125\)
   - Стандартная ошибка: \(0.01162\)
   - Значение \( t \)-статистики: \(-4.411\)
   - \( p \)-значение: \(1.15 \times 10^{-5}\)

   **Результат**: \( p \)-значение значительно меньше 0.05, что позволяет отвергнуть нулевую гипотезу и заключить, что существует статистически значимая ассоциация между физической активностью и уровнем HbA1c.

2. **Модель с ковариатами:**
   - Коэффициент: \(-0.023046\)
   - Стандартная ошибка: \(0.011031\)
   - Значение \( t \)-статистики: \(-2.089\)
   - \( p \)-значение: \(0.037\)

   **Результат**: \( p \)-значение также меньше 0.05, что указывает на сохранение статистически значимой ассоциации даже после корректировки на ковариаты.

---

### Выводы
1. **Статистическая значимость**: 
   - В обеих моделях наблюдается статистически значимая отрицательная ассоциация между логарифмом индекса физической активности и уровнем гликированного гемоглобина.
   - Корректировка на ковариаты уменьшает значение коэффициента, но сохраняет его значимость.

2. **Интерпретация результата**:
   - Увеличение физической активности связано с небольшим снижением уровня HbA1c. Однако даже после корректировки на другие факторы эффект остаётся слабым.
   - Несмотря на статистическую значимость, клиническая значимость эффекта остаётся под вопросом из-за его малой величины.

```{r}
# Создание модели с взаимодействием между Log_Activity_Index и Sex
model_gender_1 <- lm(Glycohemoglobin ~ Log_Activity_Index * Sex, data = cleaned_data_no_outliers)
summary(model_gender_1)

model_gender_2 <- lm(Glycohemoglobin ~ Log_Activity_Index * Sex + Race + Comorbidities_Score + Currently_Smokes, data = cleaned_data_no_outliers)
summary(model_gender_2)


```

### Интерпретация результатов

1. **Первая модель (без ковариат):**
   - Коэффициент для физической активности (\( \text{Log\_Activity\_Index} \)): -0.05355, \( p < 0.001 \), что указывает на статистически значимую отрицательную ассоциацию между физической активностью и уровнем HbA1c.
   - Взаимодействие между физической активностью и полом (\( \text{Log\_Activity\_Index:SexFemale} \)): Коэффициент 0.01281, \( p = 0.595 \), не является статистически значимым. Это предполагает, что эффекты физической активности на HbA1c не различаются между мужчинами и женщинами.

2. **Вторая модель (с ковариатами):**
   - Коэффициент для физической активности (\( \text{Log\_Activity\_Index} \)): -0.02639, \( p = 0.071 \), потерял статистическую значимость после добавления ковариат.
   - Взаимодействие между физической активностью и полом (\( \text{Log\_Activity\_Index:SexFemale} \)): Коэффициент 0.00769, \( p = 0.726 \), остается незначимым. Это подтверждает, что пол не является модификатором эффекта физической активности на HbA1c.
   - Значимые ковариаты:
     - **Раса (Race):** Некоторый эффект наблюдается для групп "Non-Hispanic White" (\( p < 0.001 \)) и "Other/Multi-Racial" (\( p = 0.044 \)).
     - **Суммарный индекс коморбидностей (Comorbidities_Score):** Коэффициент 0.207, \( p < 0.001 \), показывает сильную положительную ассоциацию с HbA1c.

---

### Выводы

1. **Эффект физической активности:**
   - Без учета ковариат физическая активность показывает значительное снижение уровня HbA1c.
   - После учета ковариат ассоциация становится слабее и теряет статистическую значимость. 

2. **Пол как модификатор:**
   - В обеих моделях взаимодействие между полом и физической активностью незначимо (\( p > 0.05 \)). Это говорит о том, что влияние физической активности на HbA1c не различается между мужчинами и женщинами.

Эффект физической активности был статистически значимым (\(p = 0.037\)) после корректировки на ковариаты в модели **без разделения по полу**, но потерял значимость (\(p = 0.071\)) после включения взаимодействия с полом.

### Возможные причины:

1. **Увеличение стандартной ошибки коэффициента**
   - Без взаимодействия стандартная ошибка для \(Log\_Activity\_Index\) была \(0.011031\), а \(t\)-статистика составляла \( -2.089\).
   - С взаимодействием стандартная ошибка возросла до \(0.014592\), и \(t\)-статистика снизилась до \( -1.809\).
   - Это связано с тем, что часть вариации, ранее объясняемой активностью, теперь учитывается за счет взаимодействия с полом.

2. **Снижение статистической мощности**
   - Разделение эффекта на две группы (мужчины и женщины) уменьшает доступную информацию для оценки общего эффекта активности, особенно если в выборке есть дисбаланс между мужчинами и женщинами.


### Вывод
Эффект физической активности был значимым в модели без взаимодействия с полом, так как оценивался как общий для всех респондентов. Добавление взаимодействия с полом увеличило сложность модели, увеличив стандартные ошибки и снизив статистическую мощность. Это привело к потере значимости, хотя основной эффект активности остается близким к значимому (\(p = 0.071\)).


   
## Direct эффект
Для оценки прямого (direct) эффекта физической активности на гликированный гемоглобин (HbA1c) необходимо скорректировать модель на **посредника (mediator)**, такого как индекс массы тела (BMI). Это позволит отделить эффект, который физическая активность оказывает на HbA1c через снижение массы тела, от эффекта, который она оказывает напрямую.


```{r}
# Модель общего эффекта
model_total <- lm(
  Glycohemoglobin ~ Log_Activity_Index + Sex + Race + Comorbidities_Score + Currently_Smokes,
  data = cleaned_data_no_outliers
)

# Модель прямого эффекта (включение медиатора BMI)
model_direct <- lm(
  Glycohemoglobin ~ Log_Activity_Index + BMI + Sex + Race + Comorbidities_Score + Currently_Smokes,
  data = cleaned_data_no_outliers
)

# Результаты моделей
summary(model_total)
summary(model_direct)

# Сравнение эффектов
direct_effect <- coef(model_direct)["Log_Activity_Index"]
total_effect <- coef(model_total)["Log_Activity_Index"]

cat("Общий эффект:", total_effect, "\n")
cat("Прямой эффект:", direct_effect, "\n")
```



### Диагностика моделей
```{r}
# Диагностические графики
par(mfrow = c(2, 2))
plot(model_total, main = "Модель общего эффекта")
plot(model_direct, main = "Модель прямого эффекта")
```


### Интерпретация
Общий эффект физической активности на HbA1c составляет -0.0230, а прямой эффект (исключая влияние через BMI) — -0.0191. Разница обусловлена тем, что часть влияния активности проходит через снижение массы тела. Общий эффект сильнее, так как включает опосредованное воздействие. Прямой эффект остается отрицательным, подтверждая благоприятное воздействие активности, но слабее из-за исключения медиаторов.
