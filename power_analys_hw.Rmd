---
title: "Домашнее задание – расчёт объёма выборки для КИ"
author: "Anton Tikhonenko"
date: "2024-12-23"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(TrialSize)
library(epiR)
library(DescTools)
library(rpact)
```
# Задание 1
Исследование не меньшей эффективности препарата T в сравнении с препаратом R в лечении
хронической обструктивной болезни лёгких (ХОБЛ). Первичная конечная точка – абсолютное
увеличение индекса Тиффно (ОФВ1/ЖЕЛ) за 3 месяца терапии в сравнении со значениями на
1 визите.
Из литературных данных известно, что для препарата R абсолютный прирост индекса за 3
месяца в среднем (M±SD) составлял 7.2 ± 3.1%. Предлагаемая граница не меньшей
эффективности – 2 %.

## Исходные данные и гипотеза

Статистическая гипотеза не меньшей эффективности была сформулирована следующим образом:

$H_0$: $M_T - M_R \leq \delta$

$H_A$: $M_R - M_T < \delta$

Где $M_T$ — среднее абсолютного прироста индекса Тиффно (ОФВ1/ЖЕЛ) для препарата T, $M_R$ — среднее для препарата R, $\delta$ — граница не меньшей эффективности (2%).

При расчёте необходимого размера выборки были сделаны следующие допущения:

1. Среднее значение абсолютного прироста индекса Тиффно для препарата R равно 7.2%.
2. Стандартное отклонение абсолютного прироста равно 3.1%.
3. Односторонний уровень значимости (α) составляет 0.025.
4. Мощность исследования составляет 80% (β = 0.2).
5. Граница не меньшей эффективности составляет 2%.
6. Размеры групп равны (1:1).

## Проведение расчёта

Расчёт размера выборки был проведён в RStudio (версия 2024.12.0 Build 467) с использованием языка R (версия 4.4.1) и пакета `TrialSize` (версия 1.4.1). Код расчёта представлен ниже:

## Исследование не меньшей эффективности

```{r}

# Исходные параметры
alpha <- 0.025
beta <- 0.2
sigma <- 3.1 / 100  # Стандартное отклонение
mu_r <- 7.2 / 100  # Среднее для препарата R
k <- 1

delta <- 2 / 100  # Граница не меньшей эффективности

# Расчёт с использованием TwoSampleMean.NIS
n <- TwoSampleMean.NIS(
    alpha = alpha,
    beta = beta,
    sigma = sigma,
    k = k,
    
    delta = 0, #Cчитаем одинаковыми средние значения
    margin = delta   
)
n = ceiling(n)
print(n)
```



## Коррекция на выбывание

Частота выбывания пациентов в ходе исследования – 20%.
Частота выбывания пациентов в ходе скрининга – 10%.

```{r echo = FALSE}
m = n*2
withdrawal_rate <- 0.2
screening_rate <- 0.1
withdrawal_n <- ceiling(n / (1 - withdrawal_rate))
screening_n <- ceiling(withdrawal_n/ (1 - screening_rate))
cat(sprintf(
    "Таким образом, в каждую группу необходимо включить не менее %d обследуемых, всего – %d пациента.\nС учётом частоты выбывания пациентов в ходе исследования, равной 20%%, в каждую группу необходимо набрать не менее %d человек. В скрининг (с учётом 10%% выбывания) необходимо включить не менее %d обследуемых в каждую группу.",
    n, m, withdrawal_n, screening_n
))
```
# Задание 2

Исследование превосходства препарата T над референтным лечением R в лечении
рассеянного склероза. Первичный показатель эффективности – доля пациентов, у которых к
визиту 3 (12 мес.) нет новых очагов по МРТ, развившихся в период наблюдения. Согласно
литературным данным, на фоне применения препарата R доля пациентов без новых очагов
составляет 66%. Ожидается, что препарат T будет эффективнее препарата R примерно на
15%, при этом спонсор хотел бы, чтобы граница превосходства была бы равна 1%. Спонсор
просит, чтобы в группу T было рандомизировано в 2 раза больше пациентов, чем в группу R.

## Исходные данные и гипотеза

Статистическая гипотеза превосходства была сформулирована следующим образом:

$H_0$: $P_T - P_R \leq \delta$

$H_A$: $P_T - P_R > \delta$

Где $P_T$ — доля пациентов без новых очагов в группе T, $P_R$ — доля пациентов без новых очагов в группе R, $\delta$ — граница превосходства (1%).

При расчёте необходимого размера выборки были сделаны следующие допущения:

1. Доля пациентов без новых очагов в группе R составляет 66%.
2. Ожидаемая доля пациентов без новых очагов в группе T — 81% (66% + 15%).
3. Граница превосходства составляет 1%.
4. Односторонний уровень значимости (α) составляет 0.025.
5. Мощность исследования составляет 80% (β = 0.2).
6. Соотношение размеров групп T и R равно 2:1.

## Проведение расчёта

Расчёт размера выборки был проведён в RStudio (версия 2024.12.0 Build 467) с использованием языка R (версия 4.4.1) и пакета `TrialSize` (версия 1.4.1). Код расчёта представлен ниже:

## Исследование превосходства

```{r}


# Исходные параметры
alpha <- 0.025
beta <- 0.2
p_r <- 0.66  # Доля пациентов в группе R
p_t <- 0.81  # Доля пациентов в группе T
k <- 2  # Соотношение размеров групп T и R

delta <- 0.01  # Граница превосходства

```
```{r}
result <- epi.sssupb (
    treat = 0.81,
    control = 0.66,
    delta = 0.01,
    n = NA,
    power = 0.8,
    alpha = 0.025,
    r = 2
)
print(result)
```

## Коррекция на выбывание

Частота выбывания пациентов в ходе исследования – 20%.
Частота выбывания пациентов в ходе скрининга – 10%.

```{r}
n <- result$n.control
m <- result$n.total # Общее число пациентов
withdrawal_rate <- 0.2
screening_rate <- 0.1
withdrawal_n <- ceiling(m / (1 - withdrawal_rate))
screening_n <- ceiling(withdrawal_n / (1 - screening_rate))
```

## Результаты расчёта

```{r echo = FALSE}
cat(sprintf(
    "Таким образом, в группу T необходимо включить не менее %d обследуемых, в группу R — %d, всего – %d пациента.\nС учётом частоты выбывания пациентов в ходе исследования, равной 20%%, в группу T необходимо набрать не менее %d человек, а в группу R — %d. В скрининг (с учётом 10%% выбывания) необходимо включить не менее %d обследуемых в группу T и %d в группу R.",
    ceiling(n * k), ceiling(n), ceiling(m),
    ceiling(withdrawal_n * k / (1 + k)), ceiling(withdrawal_n / (1 + k)),
    ceiling(screening_n * k / (1 + k)), ceiling(screening_n / (1 + k))
))
```
# Задание 3

Исследование превосходства нового препарата А над препаратом Б в профилактике
интраоперационных кровотечений. Первичная конечная точка – объём кровопотери в мл. Из
данных литературы известно, что средний объём кровопотери при применении препарата Б
составляет 306 ± 52 мл. Ожидается, что препарат А в среднем будет снижать объём
кровопотери на 20% в сравнении с препаратом Б. Границу превосходства предполагается
установить равной 50 мл. Спонсор просит рассчитать объём выборок таким образом, чтобы
препарат А получили 75% пациентов, включённых в исследование.


## Исследование нового препарата А

### Исходные данные

Статистическая гипотеза превосходства препарата А над препаратом Б в профилактике интраоперационных кровотечений сформулирована следующим образом:

$H_0$: $\mu_A - \mu_B \geq \delta$

$H_A$: $\mu_A - \mu_B < \delta$

Где $\mu_A$ — средний объём кровопотери в группе препарата А, $\mu_B$ — средний объём кровопотери в группе препарата Б, $\delta$ — граница превосходства (50 мл).

При расчёте необходимого размера выборки были сделаны следующие допущения:

1. Средний объём кровопотери в группе препарата Б составляет 306 мл.
2. Средний объём кровопотери в группе препарата А ожидается на 20% меньше, то есть 245 мл.
3. Стандартное отклонение кровопотери составляет 52 мл.
4. Граница превосходства составляет 50 мл.
5. Односторонний уровень значимости (α) составляет 0.025.
6. Мощность исследования составляет 80% (β = 0.2).
7. Соотношение размеров групп А и Б составляет 3:1.(75:25)

### Проведение расчёта

```{r}

# Исходные параметры
alpha <- 0.025
beta <- 0.2

mu_b <- 306  # Средний объём кровопотери для препарата Б
mu_a <- 245  # Средний объём кровопотери для препарата А
sigma <- 52   # Стандартное отклонение
k <- 3        # Соотношение групп А и Б

delta <- -50   # Граница превосходства


n <- TwoSampleMean.NIS(
    alpha = alpha,
    beta = beta,
    delta = delta,
    sigma = sigma,
    margin = mu_a - mu_b,
    k = k
)
n
```
```{r}
result <- epi.sssupc(
    treat = mu_b,
    control = mu_a,
    delta = -delta,
    sigma = sigma,
    n = NA,
    power = 0.8,
    alpha = 0.025,
    r = 3
)
print(result)
```
### Коррекция на выбывание

Частота выбывания пациентов в ходе исследования – 20%.
Частота выбывания пациентов в ходе скрининга – 10%.

```{r echo = FALSE}

m <- (k+1)*n/k  # Общее число пациентов

withdrawal_rate <- 0.2
screening_rate <- 0.1

n_total <- ceiling(m)  # Общее количество пациентов
n_treat <- ceiling(m * k / (1 + k))  # Пациенты в группе А
n_control <- ceiling(m / (1 + k))    # Пациенты в группе Б

# Коррекция на выбывание
withdrawal_n_total <- ceiling(n_total / (1 - withdrawal_rate))
withdrawal_n_treat <- ceiling(n_treat / (1 - withdrawal_rate))
withdrawal_n_control <- ceiling(n_control / (1 - withdrawal_rate))

screening_n_treat <- ceiling(withdrawal_n_treat / (1 - screening_rate))
screening_n_control <- ceiling(withdrawal_n_control / (1 - screening_rate))

# Итоговый вывод
cat(sprintf(
    "Таким образом, в группу А необходимо включить не менее %d обследуемых, в группу Б — %d, всего – %d пациента.\nС учётом частоты выбывания пациентов в ходе исследования, равной 20%%, в группу А необходимо набрать не менее %d человек, а в группу Б — %d. В скрининг (с учётом 10%% выбывания) необходимо включить не менее %d обследуемых в группу А и %d в группу Б.",
    n_treat, n_control, n_total,
    withdrawal_n_treat, withdrawal_n_control,
    screening_n_treat, screening_n_control
))

```

# Задание 4

Известно, что на фоне лечения препаратом Х рецидив псориатического артрита за 6 месяцев
наблюдается в 32% случаев. Спонсор хочет исследовать новый препарат У, который, как
ожидается, снизит частоту рецидивов на 15%. Границей превосходства можно считать
снижение доли пациентов с рецидивом более, чем на 5%.
При этом существует сложность. У спонсора в наличии имеется только 250 пачек препарата Х и
он просит, чтобы рандомизационное соотношение было таким, чтобы препарата хватило на
проведение исследования.

## Исследование нового препарата У

### Исходные данные

Статистическая гипотеза превосходства препарата У над препаратом Х в лечении псориатического артрита сформулирована следующим образом:

$H_0$: $P_Y - P_X \geq \delta$

$H_A$: $P_Y - P_X < \delta$

Где $P_Y$ — доля пациентов с рецидивом в группе препарата У, $P_X$ — доля пациентов с рецидивом в группе препарата Х, $\delta$ — граница превосходства (5%).

При расчёте необходимого размера выборки были сделаны следующие допущения:

1. Частота рецидивов в группе препарата Х составляет 32%.
2. Ожидаемая частота рецидивов в группе препарата У — 17% (32% - 15%).
3. Граница превосходства составляет 5%.
4. Односторонний уровень значимости (α) составляет 0.025.
5. Мощность исследования составляет 80% (β = 0.2).
6. В наличии имеется 250 пачек препарата Х, что ограничивает число пациентов в группе Х.

### Проведение расчёта

```{r}

# Исходные параметры
alpha <- 0.025
beta <- 0.2
p_x <- 0.32  # Доля пациентов с рецидивом для препарата Х
p_y <- 0.17  # Ожидаемая доля пациентов с рецидивом для препарата У
margin <- 0.05 # Граница превосходства
delta <- p_x - p_y  

# Определение соотношения на основе количества препарата Х

ratio <- 1/2
# Расчёт с использованием функции TwoSampleProportion.NIS

n <- TwoSampleProportion.NIS(
    alpha = alpha,
    beta = beta,
    p1 = p_y,
    p2 = p_x,
    margin = margin,
    delta = delta,
    k = ratio
)
n
```
```{r}
result <- epi.sssupb(
    treat = p_x,
    control = p_y,
    delta = margin,
    n = NA,  
    power = beta,
    alpha = alpha,
    r = ratio
)
print(result)
```

Соотношение между группами было подобрано эмпирически

### Коррекция на выбывание

Частота выбывания пациентов в ходе исследования – 20%.
Частота выбывания пациентов в ходе скрининга – 10%.

### Коррекция на выбывание

Частота выбывания пациентов в ходе исследования – 20%.
Частота выбывания пациентов в ходе скрининга – 10%.
```{r echo = FALSE}
k <- ratio
m <- (k+1)*n/k  # Общее число пациентов

withdrawal_rate <- 0.2
screening_rate <- 0.1

n_total <- ceiling(m)  # Общее количество пациентов
n_treat <- ceiling(m * k / (1 + k))  # Пациенты в группе А
n_control <- ceiling(m / (1 + k))    # Пациенты в группе Б

# Коррекция на выбывание
withdrawal_n_total <- ceiling(n_total / (1 - withdrawal_rate))
withdrawal_n_treat <- ceiling(n_treat / (1 - withdrawal_rate))
withdrawal_n_control <- ceiling(n_control / (1 - withdrawal_rate))

screening_n_treat <- ceiling(withdrawal_n_treat / (1 - screening_rate))
screening_n_control <- ceiling(withdrawal_n_control / (1 - screening_rate))

# Итоговый вывод
cat(sprintf(
    "Таким образом, в группу X необходимо включить не менее %d обследуемых, в группу Y — %d, всего – %d пациента.\nС учётом частоты выбывания пациентов в ходе исследования, равной 20%%, в группу X необходимо набрать не менее %d человек, а в группу Y — %d. В скрининг (с учётом 10%% выбывания) необходимо включить не менее %d обследуемых в группу А и %d в группу Б.",
    n_treat, n_control, n_total,
    withdrawal_n_treat, withdrawal_n_control,
    screening_n_treat, screening_n_control
))

```